# 2. Use Pact for contract testing

Date: 2023-05-24

## Status

Accepted

## Context

We're developing a service with a frontend client (the UI) that communicates
with a separate API, written by different developers often working in parallel.
When running integration tests, the UI team do this against a mocked version of
the API which may not always be in the state we expect.

We need to ensure that any changes to the API don't break existing
functionality in the user interface. Although we could use Cypress to test the
deployed application, this would have a number of drawbacks:

- We have to maintain integration and end-to-end (E2E) tests, which are functionally
  similar, but different enough for there to be differences in implementation
- We have to wait for a new version of the code to be deployed before running
  our E2E tests, meaning the feedback loop for noticing a problem and fixing it
  is long
- E2E tests are slow running, slowing down our build pipeline
- As the tests run in a real environment, we are filling the database with test
  data, which has to be cleaned out
- The tests can be flaky and pass for reasons that are outside our control,
  such as upstream APIs being down, or performance issues
- When tests do fail, it's not always clear _what_ has broken, and it can be
  hard to track down the source of the failure

## Decision

With all this in mind, we've decided to use [Pact](https://pact.io/) to carry
out contract testing when testing our API client classes.

When running Pact contract tests, JSON files called "Pacts" are generated by
"the consumer" (our UI). These are published to the Pact Broker on a successful
CI build. "The provider" then pulls these contracts and verifies its own
response shape against them to ensure it's sending what's expected to the UI.
If the shape is different to what the consumer expects, the build will fail and
prevent us merging anything that could break functionality.

## Consequences

This will hopefully speed up our development, and raise any deviation in the
contract between the API and the UI application in a timely manner without the
need for expensive and flaky E2E tests. When API changes do cause the tests to
fail, it will be easier to diagnose the cause and deploy a fix.

One drawback is that major changes to the API will cause the build to break,
and may slow down development, as we won't be able to ignore these changes as
we could with E2E tests. However this will reduce the risk of bad code making
its way into production, especially as the project moves closer to live.

There will also likely be some duplication in updating both the OpenAPI
specification and the Pact contracts and keeping them up to date, but there may
be libraries to reduce this overhead.
